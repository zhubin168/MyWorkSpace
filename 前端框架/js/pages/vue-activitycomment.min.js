"use strict";!function(t){Vue.component("activity-comment",{props:{commentUser:{type:Object,"default":function(){return{Logo:null,IsInsti:!1}}},activityId:Number,activityType:Number,autoLoadComment:Boolean,autoCheckNewComment:Boolean},data:function(){return{comments:[],pageIndex:1,enableCommentSubmit:!1,enableReplayInputBox:!1,isAnonymous:!1,isReplyAnonymous:!1,commentContent:null,commentParrent:null,replyContent:null,commentLoadComplete:!1,isShowMore:!1,lastLoadCommentTime:null}},mixins:[jhbCore.vueMixin],template:'\r\n<div class="comment">\r\n    <div v-bind:class="[\'tw-k\', comments && comments.length > 0 ? \'\' : \'tw-nok\']">\r\n        <table>\r\n            <tr>\r\n                <td class="tx-li" valign="top"><img v-bind:src="getImg(commentUser.Logo, \'http://www.jhbshow.com/imgs/head/headdef11.jpeg\')" class="img-user" /></td>\r\n                <td class="text-area" valign="top">\r\n                    <div class="tw-focus" >\r\n                        <div class="ly-tarea" id="commentArea">\r\n                            <textarea v-bind:class="[!enableCommentSubmit ? \'text-arealy\' : null]" placeholder="快来说说你的想法" ref="commentInput" v-on:focus="doEnableCommentSubmit" v-model="commentContent" v-on:blur="emitInputBlur"></textarea>\r\n                        </div>\r\n                        <div class="btn-all" v-show="enableCommentSubmit">\r\n                            <span class="nim-left" v-if="commentUser.IsInsti" v-on:click="toggleAnonymous"><i v-bind:class="[\'iconfont\', isAnonymous ? \'icon-gouxuankuang\' : \'icon-weigouxuanccc\']"></i>匿名</span>\r\n                            <div class="btn-group">\r\n                                <button class="qx" v-on:click="doDisableCommentSubmit">取消</button>\r\n                                <button class="pose" v-on:click="rootComment">发送</button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </td>\r\n            </tr>\r\n        </table>\r\n    </div>\r\n    \r\n    <div class="ly-li">\r\n        <table>\r\n            <tbody>\r\n                <tr v-for="comment in comments">\r\n                    <td class="tx-li" valign="top"><img v-bind:src="getImg(comment.CreatorImage)" v-on:error="imgLoadError" class="img-user"></td>\r\n                    <td class="hf-li">\r\n                        <!--留言展示带头像-->\r\n                        <div class="ly-zs">\r\n                            <div class="ly-name">{{comment.CreatorName}}</div>\r\n                            <div class="ly-info">\r\n                                {{comment.Content}}\r\n                            </div>\r\n                            <div class="ly-time"><span>{{formatJhbDate(comment.CreateTime)}}</span><span class="ly-hfright" v-on:click="toggleReplyInputBox($event, comment)">回复</span></div>\r\n                        </div>\r\n                        <!--留言回复展示-->\r\n                        <div class="lyhf-zs" v-for="reply in comment.ReplyList">\r\n                            <div class="ly-name"><span class="lyhf-gsname">{{reply.CreatorName}}</span><span class="hf-greg">回复:</span><span class="hf-time">{{formatJhbDate(reply.CreateTime)}}</span></div>\r\n                            <div class="ly-info">\r\n                                {{reply.Content}}\r\n                            </div>\r\n                        </div>\r\n                    </td>\r\n                </tr>\r\n            </tbody>\r\n        </table>\r\n    </div>\r\n    <div class="more">\r\n        <a class="more-a" v-show="isShowMore" v-on:click="loadMore">{{commentLoadComplete ? "没有更多了！" : "点击查看更多"}}</a>\r\n    </div>\r\n    <div class="ly-zs lyhf-input" ref="replyInputBox" v-show="enableReplayInputBox">\r\n        <div class="ly-name"><span class="lyhf-gsname">我</span><span class="hf-greg">回复:</span></div>\r\n        <div class="ly-tarea">\r\n            <textarea placeholder="快来说说你的想法" v-model="replyContent" v-on:focus="emitInputFoucs" v-on:blur="emitInputBlur"></textarea>\r\n        </div>\r\n        <div class="btn-all">\r\n            <span class="nim-left" v-if="commentUser.IsInsti" v-on:click="toggleReplyAnonymous"><i v-bind:class="[\'iconfont\', isReplyAnonymous ? \'icon-gouxuankuang\' : \'icon-weigouxuanccc\']"></i>匿名</span>\r\n            <div class="btn-group">\r\n               <button class="qx" v-on:click="closeReplyInputBox">取消</button>\r\n                <button class="pose" v-on:click="replyComment">发送</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n        ',created:function(){var t=this;this.autoLoadComment&&this.loadComment(),this.autoCheckNewComment&&setInterval(function(){t.checkHasNewComment()},6e4)},methods:{doEnableCommentSubmit:function(){this.enableCommentSubmit=!0,this.emitInputFoucs()},doDisableCommentSubmit:function(){this.enableCommentSubmit=!1},loadComment:function(t){var n=this,e=jhbGlobal.jhbApi+"/activity/listactivitycomment";t&&(n.pageIndex=1),n.lastLoadCommentTime=new Date,n.httpPost(e,{activityId:n.activityId,type:n.activityType,pageIndex:n.pageIndex}).then(function(t){if(t.code&&t.data&&t.data.length>0){var e=1===n.pageIndex;n.comments=e?t.data:n.comments.concat(t.data),t.data.length<t.pageSize?(n.isShowMore=!e,n.commentLoadComplete=!0):(n.isShowMore=!0,n.commentLoadComplete=!1)}else n.commentLoadComplete=!0})},toggleAnonymous:function(){this.isAnonymous=!this.isAnonymous},toggleReplyAnonymous:function(){this.isReplyAnonymous=!this.isReplyAnonymous},toggleReplyInputBox:function(n,e){t(this.$refs.replyInputBox).insertAfter(t(n.target).parents(".ly-zs")),this.enableReplayInputBox=!0,this.commentParrent=e},closeReplyInputBox:function(){this.enableReplayInputBox=!1},rootComment:function(){var t=this,n={parentCommentId:0,postText:this.commentContent,isAnonymous:this.isAnonymous};this.doComment(n,function(n){t.enableCommentSubmit=!1,t.commentContent=null,t.comments.splice(0,0,{Id:n.QadetailId,CreatorName:n.CreatorName,CreatorImage:n.CreatorHeaderImage,CreateTime:n.DateCreated,Content:n.PostText})})},replyComment:function(){var t=this,n={parentCommentId:this.commentParrent.Id,postText:this.replyContent,isAnonymous:this.isReplyAnonymous};this.doComment(n,function(n){t.commentParrent.ReplyList||(t.commentParrent.ReplyList=[]),t.commentParrent.ReplyList.splice(0,0,{Id:n.QadetailId,CreatorName:n.CreatorName,CreatorImage:n.CreatorHeaderImage,CreateTime:n.DateCreated,Content:n.PostText}),t.replyContent=null,t.enableReplayInputBox=!1})},doComment:function(t,n){var e=this,o=jhbGlobal.jhbApi+"/activity/createcomment";return t.postText?(e.showLoading(),void this.httpPost(o,{type:e.activityType,mainId:e.activityId,parentCommentId:t.parentCommentId,postText:t.postText,isAnonymous:t.isAnonymous}).then(function(t){t.code&&(weui.toast("提交成功",1e3),n&&n(t.data))})):(weui.alert("请输入内容"),!1)},focusComment:function(){this.$refs.commentInput.focus()},loadMore:function(){this.commentLoadComplete||(this.pageIndex++,this.loadComment())},checkHasNewComment:function(){var t=this,n=jhbGlobal.jhbApi+"/activity/hasNewComment";t.httpPost(n,{RelateId:t.activityId}).then(function(n){n.code&&n.data&&t.$emit("newcomment")})},emitInputFoucs:function(){console.log("commentfocus"),this.$emit("commentfocus")},emitInputBlur:function(){console.log("commentblur"),this.$emit("commentblur")}}})}(Zepto);